<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Use correct character set. -->
  <meta charset="utf-8">
  <!-- Tell IE to use the latest, best version (or Chrome Frame if pre-IE11). -->
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <!-- Make the application on mobile take up the full browser screen and disable user scaling. -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
  <title>Hello World!</title>
  <script src="../../../../Build/Cesium/Cesium.js"></script>
  <style>
      @import url(../../../../Build/Cesium/Widgets/widgets.css);
      html, body, #cesiumContainer {
          width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden;
      }
  </style>
</head>
<body>
<div id="cesiumContainer"></div>
<script>
function startup(Cesium) {

	var viewer = new Cesium.Viewer('cesiumContainer', {
		fullscreenButton : false,
		geocoder : false,
		homeButton : false,
		sceneModePicker : false,
		navigationHelpButton : false, 
		selectionIndicator : false,
		targetFrameRate : 24
	});
	
	var count = 0;
	var rectangles = [];
	var rectanglesFreq = [];
	//north/south
	for(var i = -180; i < 180; i+=5) {
		for(var j = -85; j < 85; j+=5) {
			rectangles[count] = new Cesium.Rectangle.fromDegrees(i, j, i+5, j+5);
			rectanglesFreq[count] = 0;
			/*viewer.entities.add({
				name : 'Green translucent, rotated, and extruded rectangle at height with outline',
				rectangle : {
					coordinates : Cesium.Rectangle.fromDegrees(i, j, i+1, j+1),
					material : Cesium.Color.GREEN.withAlpha(0.5),
					outline : true
				}
			});*/
			count++;
		}
	}
	
	var allDataSources = new Cesium.DataSourceCollection();
	allDataSources.add(Cesium.KmlDataSource.load("../Resources/coverage6.kmz")).then(function() {
		allDataSources.add(Cesium.KmlDataSource.load("../Resources/coverage5.kmz"));
		allDataSources.add(Cesium.KmlDataSource.load("../Resources/coverage3.kmz"));
		allDataSources.add(Cesium.KmlDataSource.load("../Resources/coverage2.kmz"));
		allDataSources.add(Cesium.KmlDataSource.load("../Resources/coverage0.kmz")).then(function(dataSource) {
			console.log(allDataSources.length)
			var dataRectangles = [];
			for(var j = 0; j < allDataSources.length; j++) {
				var values = allDataSources.get(j).entities.values
				for(var i = 0; i < values.length; i++) {
					var position = viewer.scene.globe.ellipsoid.cartesianArrayToCartographicArray(values[i].polygon.hierarchy.getValue(viewer.clock.currentTime).positions);
					dataRectangles.push(Cesium.Rectangle.fromCartographicArray(position));
				}
			}
			
			console.log(dataRectangles)
			
			var centers = [];
			count = 0;
			for(var i = 0; i < dataRectangles.length; i++) {
				centers[i] = Cesium.Rectangle.center(dataRectangles[i]);
			}
			
			console.log(centers)
			
			for(var i = 0; i < rectangles.length; i++) {
				for(var j = 0; j < centers.length; j++) {
					if(Cesium.Rectangle.contains(rectangles[i], centers[j])) {
						rectanglesFreq[i]++;
					}
				}
				//console.log(rectanglesFreq[i])
			}
			
			for(var i = 0; i < allDataSources.length; i++) {
				viewer.dataSources.add(allDataSources.get(i));
			}
		});
	});
	
	var eventHandler = new Cesium.ScreenSpaceEventHandler();
	eventHandler.setInputAction(function() {
		viewer.dataSources.removeAll(true);
	}, Cesium.ScreenSpaceEventType.LEFT_CLICK);
	
	eventHandler.setInputAction(function() {
		for(var i = 0; i < rectangles.length; i++) {
			if(rectanglesFreq[i] > 0) {
				viewer.entities.add({
					rectangle : {
						coordinates : rectangles[i],
						material : Cesium.Color.GREEN.withAlpha(0.5),
						outline : true,
						extrudedHeight : rectanglesFreq[i] * 100000
					}
				})
			}
		}
	}, Cesium.ScreenSpaceEventType.RIGHT_CLICK);
	
}
	
if (typeof Cesium !== "undefined") {
	startup(Cesium);
} else if (typeof require === "function") {
	require(["Cesium"], startup);
}	

</script>
  
</body>
</html>