<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Use correct character set. -->
  <meta charset="utf-8">
  <!-- Tell IE to use the latest, best version (or Chrome Frame if pre-IE11). -->
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <!-- Make the application on mobile take up the full browser screen and disable user scaling. -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
  <title>Hello World!</title>
  <script src="../../../../Build/Cesium/Cesium.js"></script>
  <style>
      @import url(../../../../Build/Cesium/Widgets/widgets.css);
      html, body, #cesiumContainer {
          width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden;
      }
  </style>
</head>
<body>
<div id="cesiumContainer"></div>
<script>
function startup(Cesium) {

	var viewer = new Cesium.Viewer('cesiumContainer', {
		baseLayerPicker : false,
		fullscreenButton : false,
		geocoder : false,
		homeButton : false,
		navigationHelpButton : false, 
		selectionIndicator : false,
		targetFrameRate : 24
	});
	
	
	var timeStart = Cesium.JulianDate.fromIso8601("2015-06-02T00:00:30Z");
	var timeEnd = Cesium.JulianDate.fromIso8601("2015-06-02T23:59:30Z");
	viewer.timeline.zoomTo(timeStart, timeEnd);
	viewer.clock.startTime = timeStart.clone();
	viewer.clock.stopTime = timeEnd.clone();
	viewer.clock.currentTime = timeStart.clone();
	viewer.clock.clockRange = Cesium.ClockRange.LOOP_STOP;
	viewer.clock.multiplier = 1;
	viewer.clock.clockStep = Cesium.ClockStep.TICK_DEPENDENT;
	
	
	viewer.dataSources.add(Cesium.KmlDataSource.load("../Resources/Generated kml/doc.kml")).then(function(dataSource) {
	
		console.log(dataSource.entities.values.length)
		
		for(var i = 0; i < dataSource.entities.values.length; i++) {
			var pos = new Cesium.SampledPositionProperty();
			var width = new Cesium.SampledProperty(Number);
			var middle = Cesium.JulianDate.secondsDifference(timeEnd, timeStart);
			middle = middle / 2;
			middle = Cesium.JulianDate.addSeconds(timeStart, middle, new Cesium.JulianDate());
			
			
			var starting = dataSource.entities.getById(dataSource.entities.values[i].id).polyline.positions._value[0];
			starting = viewer.scene.globe.ellipsoid.cartesianToCartographic(starting);
			starting.height = Math.floor(Math.random() * 1000000);
			starting = viewer.scene.globe.ellipsoid.cartographicToCartesian(starting);
			var ending = dataSource.entities.getById(dataSource.entities.values[i].id).polyline.positions._value[0];
			ending = viewer.scene.globe.ellipsoid.cartesianToCartographic(ending);
			ending.height = Math.floor(Math.random() * 1000000);
			var middleHeight = ending.clone();
			middleHeight.height = Math.floor(Math.random() * 1000000);
			ending = viewer.scene.globe.ellipsoid.cartographicToCartesian(ending);
			middleHeight = viewer.scene.globe.ellipsoid.cartographicToCartesian(middleHeight);
			
			pos.addSample(timeStart, starting);
			pos.addSample(middle, middleHeight);
			pos.addSample(timeEnd, ending);
			
			width.addSample(timeStart, Math.floor(Math.random() * 10));
			width.addSample(middle, Math.floor(Math.random() * 10));
			width.addSample(timeEnd, Math.floor(Math.random() * 10));
			
			
			var positions2 = [new Cesium.ConstantPositionProperty(dataSource.entities.getById(dataSource.entities.values[i].id).polyline.positions._value[0]), pos];
			positions2 = new Cesium.PositionPropertyArray(positions2);
			console.log(dataSource.entities.getById(dataSource.entities.values[i].id).polyline.positions);
			//var staticPos = [dataSource.entities.getById(dataSource.entities.values[i].id).polyline.positions._value[0], ending];
			dataSource.entities.getById(dataSource.entities.values[i].id).polyline.positions = positions2;
			dataSource.entities.getById(dataSource.entities.values[i].id).polyline.width = width;
		
		}
		
		
		
		console.log("Done");
		
	})
	
	/*var timeStart = Cesium.JulianDate.fromIso8601("2015-06-02T00:00:30Z");
	var timeEnd = Cesium.JulianDate.fromIso8601("2015-06-02T23:59:30Z");
	viewer.timeline.zoomTo(timeStart, timeEnd);
	viewer.clock.startTime = timeStart.clone();
	viewer.clock.stopTime = timeEnd.clone();
	viewer.clock.currentTime = timeStart.clone();
	viewer.clock.clockRange = Cesium.ClockRange.LOOP_STOP;
	viewer.clock.multiplier = 1;
	
	console.log("Done creating clock");	
	
	viewer.dataSources.add(Cesium.KmlDataSource.load("../Resources/comprehensive_precipitation.kml")).then(function(dataSource) {
		
		console.log(dataSource.entities.values.length);
		
		
		
		var header = '<?xml version="1.0" encoding="UTF-8"?><kml xmlns="http://www.opengis.net/kml/2.2" xmlns:gx="http://www.google.com/kml/ext/2.2" xmlns:kml="http://www.opengis.net/kml/2.2" xmlns:atom="http://www.w3.org/2005/Atom"><Document><Style id="theLabelStyle"><color>00000000</color><IconStyle><Icon></Icon></IconStyle><LabelStyle><color>ffffffff</color><scale>2.0</scale></LabelStyle></Style>'
		var footer = '</Document></kml>'
		var placemark1 = '<Placemark><name>';
		var placemark2 = '</name><Style><LineStyle><color>'
		var placemark3 = '</color></LineStyle></Style><LineString id="LineString"><coordinates>';
		var placemark4 = '</coordinates><gx:altitudeMode>clampToGround</gx:altitudeMode><gx:drawOrder>10</gx:drawOrder></LineString><ExtendedData><Data name="Precipitation (mm)"><value>';
		var placemark5 = '</value></Data></ExtendedData></Placemark>';
		
		
		var count = 0;
		var endingString = "";
		endingString += header;
		for(var i = 1000; i < 6710; i+=2) {
			var array = [];
			for(var j = 0; j < 4; j++) {
				array[j] = viewer.scene.globe.ellipsoid.cartesianToCartographic(dataSource.entities.values[i].polyline.positions._value[j]);
			}
			//console.log(array);
			var rectangle = Cesium.Rectangle.fromCartographicArray(array);
			var center = Cesium.Rectangle.center(rectangle);
			//console.log(Cesium.Math.toDegrees(center.latitude))
			if((Cesium.Math.toDegrees(center.latitude) > 15) && (Cesium.Math.toDegrees(center.latitude) < 70) && (Cesium.Math.toDegrees(center.longitude) > -170) && (Cesium.Math.toDegrees(center.longitude) < -50)) {
			//console.log(center);
			endingString += placemark1;
			endingString += dataSource.entities.values[i+1].name;
			endingString += placemark2;
			endingString += dataSource.entities.values[i].polyline.material.color._value.toRgba().toString(16);
			endingString += placemark3;
			var coords = center;
			var coordsString = Cesium.Math.toDegrees(coords.longitude) + "," + Cesium.Math.toDegrees(coords.latitude) + "," + "0 ";
			endingString += coordsString;
			endingString += placemark4;
			endingString += dataSource.entities.values[i+1].name;
			endingString += placemark5;
			count++;
			}
			
		}
		
		endingString += footer;
		
		console.log(endingString);
		console.log(count);
		console.log("Done");
		});*/
	
}
	
if (typeof Cesium !== "undefined") {
	startup(Cesium);
} else if (typeof require === "function") {
	require(["Cesium"], startup);
}	

</script>
  
</body>
</html>